###### tags: `Spring`
# Spring Web Security 

##  Security Builder
[spring-security-configuration-architecture](https://medium.com/@yovan/spring-security-configuration-architecture-c9694435330a)  
[spring-security-login](https://www.javadevjournal.com/spring-security/spring-security-login/)  

Interface `SecurityBuilder` help us to build up `SecurityConfigurer` Set.
![](https://i.imgur.com/S8nhgsZ.png)  

A `SecurityConfigurer` set are the filters for series of authentication procession (e.g below diagram)
![](https://i.imgur.com/Y1VV0zM.png)  

## Security Configuration
- [Source](https://stackoverflow.com/questions/35218354/difference-between-registerglobal-configure-configureglobal-configureglo)

#### WebSecurityConfigurerAdapter
[SourceCode](https://github.com/spring-projects/spring-security/blob/main/config/src/main/java/org/springframework/security/config/annotation/web/configuration/WebSecurityConfigurerAdapter.java)

```java
/**
 * Provides a convenient base class for creating a {@link WebSecurityConfigurer} instance.
 * The implementation allows customization by overriding methods.
 *
 * <p>
 * Will automatically apply the result of looking up {@link AbstractHttpConfigurer} from
 * {@link SpringFactoriesLoader} to allow developers to extend the defaults. 
 *
 * @see EnableWebSecurity
 * @author Rob Winch
 */
@Order(100)
public abstract class WebSecurityConfigurerAdapter 
implements WebSecurityConfigurer<WebSecurity> {
    //..
}
```

There are THREE Security Builders implementation that are provided by Spring Security generated by `WebSecurityConfigurerAdapter`
![](https://i.imgur.com/nLBXbID.png)   
1. `WebSecurity` & `HttpSecurity`
    >Each `WebSecurityConfigurerAdapter` implementation will create different `WebSecurity` or `HttpSecurity` as the Filter (to form a Filter Chain) 
2. `AuthenticationManagerBuilder` (How to Authenticate)
    - Spring Security provides some configuration helpers to quickly get common authentication manager features set up in your application. **The most commonly used helper is the `AuthenticationManagerBuilder`, which is great for setting up in-memory, JDBC, or LDAP user details or for adding a custom `UserDetailsService`**  

### WebSecurity and HttpSecurity
- [Class `HttpSecurity`](https://reurl.cc/6ZXMRO)  
- [Examples](https://blog.csdn.net/weixin_44516305/article/details/88868791)

`WebSecurityConfigurerAdapter` provides a set of methods to enable specific web security configuration via different Security Builders (e.g `HttpSecurity` , `WebSecurity` ... etc ...)  

For example
```java
@EnableWebSecurity
public class AppSecurityConfig extends WebSecurityConfigurerAdapter {

    /**
      * configure() method is used to configure distinct security points 
      *  for our application 
      *  (e.g. secure and non-secure urls, success handlers etc.).
      */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
            //Login and register page to be accessible without any required(Everyone can access theses two pages).
            .antMatchers("/login", "/register").permitAll()
            //Allowing only logged is customer to access URLs matching with pattern `/account/**`.
            //     Looking for a certain role before allowing the user to access the URL.
            .antMatchers("/account/**").access("hasRole('ROLE_ADMIN')")
            .and()
            .formLogin(form - > 
	    	form.loginPage("/login")
                	// A successful authentication, then redirect the user to
                	.defaultSuccessUrl("/home")
                	// if login fails, then redirect the user to 
                	.failureUrl("/login?error=true")
            );
    }

    @Override
    public void configure(WebSecurity web) {
        web.ignoring()
            .antMatchers("/resources/**", "/static/**");
    }

    /* How Our Authentication authenticates the users */
  @Bean
  public DaoAuthenticationProvider daoAuthenticationProvider() 
  {
      DaoAuthenticationProvider authenticationProvider = 
          new DaoAuthenticationProvider();
      authenticationProvider.setUserDetailsService(customUserService); 
      authenticationProvider.setPasswordEncoder(passwordEncoder());
      return authenticationProvider;
  }

  // Build Up a Authentication Provider 
  // to authenticate the client
  @Override
  protected void configure(AuthenticationManagerBuilder auth) throws Exception {
    // Configure Authentication Procedure
    // using daoAuthenticationProvider
    // to authenticate the User accounts
    auth.authenticationProvider(daoAuthenticationProvider()); 
  }
}
```
- When clients sent requests, these will be intercepted by `FilterSecurityInterceptor` and filtered by various `WebSecurityConfigurerAdapter` implementations.
  > Once the Request's URL that requires the authentication Spring會從`SecurityContextHolder`取得該Client的`Authentication` reference. 判斷是否已經認證過，決定該Client能不能Access。

### AuthenticationManagerBuilder
We can have different Authentication Provider via `WebSecurityConfigurerAdapters`, and also limit some of `WebSecurityConfigurerAdapters` for some specific Authentications

### Global Authentication Procedure

To configuration Global Authentication Authentication
-  Annotation MUST be in a class annotated with one of the following : 
   1.  `@EnableWebSecurity`
   2.  `@EnableWebMvcSecurity`
   3.  `@EnableGlobalMethodSecurity`
   4.  `@EnableGlobalAuthentication`  
  
- Configure a global authentication method with annotation `@Autowired` and having `AuthenticationManagerBuilder` parameter 

Global Security configuration methods are often named as `registerGlobal, configureGlobal, configureGlobalSecurity` which means you are applying this method to be used(shared) by **Entire Application** (for all the other `WebSecurityConfigurerAdapters`)  
```java
@EnableWebSecurity
public class MyConfiguration {
    @Autowired
    public void (AuthenticationManagerBuilder auth) throws Exception {
        /**
         * @Description AuthenticationConfigure
         *     How to configure our Authentication Provider
         *     如何認證方式（需要user name, email or password 等等)
         */
        auth.AuthenticationConfigure( ... );
}

/**
  * For example  
  * To Apply this Authentication Provider 
  * via {@code jdbcAuthentication} to all
  * {@code WebSecurityConfigurerAdapters}
  * implementation
  */


/**
 * <p> code reference </p> 
 * {@link https://stackoverflow.com/questions/32035703/security-config-configureglobal}
 */
@Autowired
private DataSource dataSource;

/**
 *  @Description
 *   We have a authentication method
 *   via {@code jdbcAuthentication}
 *   Method is applied for all securityConfiguration 
 *   with annotation <pre> @EnableWebSecurity </pre>
 */
@Autowired
public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
    auth.jdbcAuthentication()
            .dataSource(dataSource)
            .withDefaultSchema()
            .withUser("user").password("password").roles("USER").and()
            .withUser("admin").password("password").roles("USER", "ADMIN");
}
```

By default `jdbcAuthentication` expects that:
```sql
select username, password, enabled 
from users where username = ?
```

### Specific Authentication

1. Overriding configure is a convenient approach in a subclass of `WebSecurityConfigurerAdapter` (or any `@Configuration` class implementing `WebSecurityConfigurer`)

2. The protected configure is like an anonymous inner bean where the scope is limited to that of this `WebSecurityConfigurerAdapter`.

3. If we need it **exposed** as a Bean, we can use `authenticationManagerBean.` 
Alternatively, we can also just expose one of a `UserDetailsService`, `AuthenticationProvider`, or `AuthenticationManger` as a Bean.

```java
/**
 * <p> 
 * This In Memory Authentication only applied
 * for A SPECIFIC authenticationManager 
 * </p>
 */
@Configuration
@EnableWebSecurity
public class MySecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.inMemoryAuthentication()
          .withUser("user").password("password").roles("USER").and()
          .withUser("admin").password("password").roles("USER", "ADMIN");
    }
}
```
